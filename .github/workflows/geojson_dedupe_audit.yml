name: GeoJSON Dedupe + Overlap Audit

on:
  pull_request:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  geojson-dedupe-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install minimal deps
        shell: bash
        run: |
          set -euxo pipefail
          python -m pip install -U pip
          python -m pip install -U shapely

      - name: Compile tools and tests
        shell: bash
        run: |
          set -euxo pipefail
          python -m py_compile tools/*.py tests/*.py

      - name: Unit tests
        shell: bash
        run: |
          set -euxo pipefail
          python -m unittest discover -s tests -p "test_*.py" -v

      - name: End-to-end dedupe then audit (fixture)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p /tmp/geojson_ci

          python tools/dedupe_geojson_polygons.py \
            --in-geojson tests/fixtures/overlap_fixture.geojson \
            --out-geojson /tmp/geojson_ci/out.geojson \
            --iou 0.35 \
            --stats \
            --precision 7 \
            --top-k 10

          python tools/audit_geojson_overlaps.py \
            --in-geojson /tmp/geojson_ci/out.geojson \
            --iou 0.35 \
            --top-k 10
